"use strict";(self["webpackChunkhealth_app"]=self["webpackChunkhealth_app"]||[]).push([[973],{973:function(e,a,l){l.r(a),l.d(a,{default:function(){return V}});l(4114),l(8111),l(116),l(4603),l(7566),l(8721);var t=l(6768),s=l(4232),o=l(5130),n=l(144),i=l(715),r=l(1387),u=l(4373);const c={class:"report-page"},d={class:"content"},p={class:"report-list"},v={class:"report-title"},m={class:"report-time"},k={class:"cell-right"},f={class:"pagination-wrapper"},g={class:"content"},y={class:"report-list"},h={class:"report-title"},b={class:"report-time"},w={class:"cell-right"},P={class:"pagination-wrapper"},C={class:"preview-container"},_=["src"],F=["src"],L={key:2,class:"unsupported-preview"},D=10,R=10;var K={__name:"Report",setup(e){const a=(0,r.rd)(),l=(0,n.KR)("my"),K=(0,n.KR)([]),U=(0,n.KR)(!1),W=(0,n.KR)(1),V=(0,n.KR)(0),T=(0,n.KR)(null),X=(0,n.KR)(!1),I=(0,n.KR)(null),z=(0,n.KR)(null),E=(0,n.KR)(!1),S=(0,n.KR)(null),$=(0,n.KR)([]),Q=(0,n.KR)(!1),x=(0,n.KR)(1),G=(0,n.KR)(0),A=(0,n.KR)(null),M=u.A.create({baseURL:"https://lgj-8082.colorstoneai.com",timeout:6e4,headers:{"Content-Type":"application/json"}});M.interceptors.request.use((e=>{const a=localStorage.getItem("token");return a&&(e.headers.Authorization=`Bearer ${a}`),e}));const N=async()=>{if(!U.value)try{U.value=!0,(0,i.D0)({message:"加载中...",forbidClick:!0});const e=await M.get("/api/v1/reports",{params:{page:W.value,size:D,planType:1}});0===e.data.code?(K.value=e.data.data||[],V.value=e.data.total||0):(0,i.P0)(e.data.message||"获取列表失败")}catch(e){console.error("获取报告列表失败:",e),403===e.response?.status?((0,i.P0)("登录已过期，请重新登录"),localStorage.removeItem("token"),a.push("/login")):(0,i.P0)("获取列表失败")}finally{U.value=!1,(0,i.cQ)()}},j=e=>{W.value=e,z.value=null,N()},q=()=>{T.value.click()},B=async e=>{const l=e.target.files[0];if(!l)return;const t=new FormData;t.append("file",l);try{(0,i.D0)({message:"上传中...",forbidClick:!0});const e=await M.post("/api/v1/reports/upload",t,{headers:{"Content-Type":"multipart/form-data"}});0===e.data.code?((0,i.P0)("上传成功"),W.value=1,N()):(0,i.P0)(e.data.message||"上传失败")}catch(s){403===s.response?.status?((0,i.P0)("登录已过期，请重新登录"),localStorage.removeItem("token"),a.push("/login")):((0,i.P0)("上传失败"),console.error("上传失败:",s))}finally{(0,i.cQ)()}},H=async()=>{if(!z.value)return void(0,i.P0)("请先选择一份报告");const e=K.value.find((e=>e.id===z.value));if(e)try{(0,i.D0)({message:"生成中...",forbidClick:!0,duration:0});const a=new URLSearchParams;a.append("reportId",e.id),a.append("reportUrl",e.fileUrl),a.append("planType","1");const l=await M.post("/api/health-plan/generatepdf",a,{headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:12e4});0===l.data.code?(0,i.P0)("PDF生成成功"):(0,i.P0)(l.data.message||"PDF生成失败")}catch(l){403===l.response?.status?((0,i.P0)("登录已过期，请重新登录"),localStorage.removeItem("token"),a.push("/login")):((0,i.P0)("PDF生成失败"),console.error("生成PDF失败:",l))}finally{(0,i.cQ)()}else(0,i.P0)("所选报告不存在")},Y=e=>new Date(e).toLocaleDateString(),J=e=>{I.value=e,X.value=!0},O=e=>{e?.fileUrl&&window.open(e.fileUrl,"_blank")},Z=e=>{e.preventDefault();const a=document.querySelector(".preview-dialog"),l=a.offsetHeight,t=e.clientY,s=e=>{const s=e.clientY-t,o=Math.min(Math.max(l+s,400),.95*window.innerHeight);a.style.height=`${o}px`},o=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",o)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",o)},ee=e=>{S.value=e,E.value=!0},ae=async()=>{if(S.value)try{(0,i.D0)({message:"删除中...",forbidClick:!0});const e=await M.delete(`/api/v1/reports/${S.value.id}`);0===e.data.code?((0,i.P0)("删除成功"),1===K.value.length&&W.value>1&&W.value--,N()):(0,i.P0)(e.data.message||"删除失败")}catch(e){console.error("删除失败:",e),403===e.response?.status||401===e.response?.status?((0,i.P0)("登录已过期，请重新登录"),localStorage.removeItem("token"),a.push("/login")):(0,i.P0)("删除失败，请重试")}finally{(0,i.cQ)(),S.value=null}},le=async()=>{if(!Q.value)try{Q.value=!0,(0,i.D0)({message:"加载中...",forbidClick:!0});const e=await M.get("/api/v1/reports",{params:{page:x.value,size:R,planType:2}});0===e.data.code?($.value=e.data.data||[],G.value=e.data.total||0):(0,i.P0)(e.data.message||"获取列表失败")}catch(e){console.error("获取他人报告列表失败:",e),(0,i.P0)("获取列表失败")}finally{Q.value=!1,(0,i.cQ)()}},te=e=>{x.value=e,A.value=null,le()},se=async()=>{if(!A.value)return void(0,i.P0)("请先选择一份报告");const e=$.value.find((e=>e.id===A.value));if(e)try{(0,i.D0)({message:"生成中...",forbidClick:!0,duration:0});const a=new URLSearchParams;a.append("reportId",e.id),a.append("reportUrl",e.fileUrl),a.append("planType","2");const l=await M.post("/api/health-plan/generatepdf",a,{headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:12e4});0===l.data.code?(0,i.P0)("PDF生成成功"):(0,i.P0)(l.data.message||"PDF生成失败")}catch(a){console.error("生成PDF失败:",a),(0,i.P0)("PDF生成失败")}finally{(0,i.cQ)()}else(0,i.P0)("所选报告不存在")};return(0,t.wB)(l,(e=>{"others"===e&&0===$.value.length&&le()})),(0,t.sV)((()=>{"my"===l.value?N():"others"===l.value&&le()})),(e,a)=>{const n=(0,t.g2)("van-button"),i=(0,t.g2)("van-radio"),r=(0,t.g2)("van-tag"),u=(0,t.g2)("van-cell"),S=(0,t.g2)("van-empty"),M=(0,t.g2)("van-pagination"),N=(0,t.g2)("van-tab"),le=(0,t.g2)("van-tabs"),oe=(0,t.g2)("van-dialog");return(0,t.uX)(),(0,t.CE)("div",c,[(0,t.bF)(le,{active:l.value,"onUpdate:active":a[4]||(a[4]=e=>l.value=e),sticky:""},{default:(0,t.k6)((()=>[(0,t.bF)(N,{title:"我的报告",name:"my"},{default:(0,t.k6)((()=>[(0,t.Lk)("div",d,[(0,t.bF)(n,{type:"primary",block:"",onClick:q,class:"upload-btn"},{default:(0,t.k6)((()=>a[8]||(a[8]=[(0,t.eW)(" 上传报告 ")]))),_:1}),(0,t.Lk)("div",p,[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(K.value,(e=>((0,t.uX)(),(0,t.Wv)(u,{key:e.id},{icon:(0,t.k6)((()=>[(0,t.bF)(i,{name:e.id,modelValue:z.value,"onUpdate:modelValue":a[0]||(a[0]=e=>z.value=e),class:"report-radio"},null,8,["name","modelValue"])])),title:(0,t.k6)((()=>[(0,t.Lk)("div",v,(0,s.v_)(e.fileName),1),(0,t.Lk)("div",m,(0,s.v_)(Y(e.uploadTime)),1)])),"right-icon":(0,t.k6)((()=>[(0,t.Lk)("div",k,[(0,t.bF)(r,{type:1===e.pdfGenerated?"success":"warning",class:"status-tag"},{default:(0,t.k6)((()=>[(0,t.eW)((0,s.v_)(1===e.pdfGenerated?"已生成":"已上传"),1)])),_:2},1032,["type"]),(0,t.bF)(n,{type:"primary",size:"small",onClick:(0,o.D$)((a=>J(e)),["stop"]),class:"view-btn"},{default:(0,t.k6)((()=>a[9]||(a[9]=[(0,t.eW)(" 查看 ")]))),_:2},1032,["onClick"]),(0,t.bF)(n,{type:"danger",size:"small",onClick:(0,o.D$)((a=>ee(e)),["stop"]),class:"delete-btn"},{default:(0,t.k6)((()=>a[10]||(a[10]=[(0,t.eW)(" 删除 ")]))),_:2},1032,["onClick"])])])),_:2},1024)))),128))]),(0,t.Lk)("div",f,[U.value||K.value.length?((0,t.uX)(),(0,t.Wv)(M,{key:1,modelValue:W.value,"onUpdate:modelValue":a[1]||(a[1]=e=>W.value=e),"total-items":V.value,"items-per-page":D,"show-page-size":3,"force-ellipses":"",onChange:j},null,8,["modelValue","total-items"])):((0,t.uX)(),(0,t.Wv)(S,{key:0,description:"暂无报告"}))]),(0,t.bF)(n,{type:"info",block:"",onClick:H,class:"generate-btn",disabled:!z.value},{default:(0,t.k6)((()=>a[11]||(a[11]=[(0,t.eW)(" 生成PDF报告 ")]))),_:1},8,["disabled"])])])),_:1}),(0,t.bF)(N,{title:"他人报告",name:"others"},{default:(0,t.k6)((()=>[(0,t.Lk)("div",g,[(0,t.bF)(n,{type:"primary",block:"",onClick:q,class:"upload-btn"},{default:(0,t.k6)((()=>a[12]||(a[12]=[(0,t.eW)(" 上传报告 ")]))),_:1}),(0,t.Lk)("div",y,[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)($.value,(e=>((0,t.uX)(),(0,t.Wv)(u,{key:e.id},{icon:(0,t.k6)((()=>[(0,t.bF)(i,{name:e.id,modelValue:A.value,"onUpdate:modelValue":a[2]||(a[2]=e=>A.value=e),class:"report-radio"},null,8,["name","modelValue"])])),title:(0,t.k6)((()=>[(0,t.Lk)("div",h,(0,s.v_)(e.fileName),1),(0,t.Lk)("div",b,(0,s.v_)(Y(e.uploadTime)),1)])),"right-icon":(0,t.k6)((()=>[(0,t.Lk)("div",w,[(0,t.bF)(r,{type:1===e.pdfGenerated?"success":"warning",class:"status-tag"},{default:(0,t.k6)((()=>[(0,t.eW)((0,s.v_)(1===e.pdfGenerated?"已生成":"已上传"),1)])),_:2},1032,["type"]),(0,t.bF)(n,{type:"primary",size:"small",onClick:(0,o.D$)((a=>J(e)),["stop"]),class:"view-btn"},{default:(0,t.k6)((()=>a[13]||(a[13]=[(0,t.eW)(" 查看 ")]))),_:2},1032,["onClick"]),(0,t.bF)(n,{type:"danger",size:"small",onClick:(0,o.D$)((a=>ee(e)),["stop"]),class:"delete-btn"},{default:(0,t.k6)((()=>a[14]||(a[14]=[(0,t.eW)(" 删除 ")]))),_:2},1032,["onClick"])])])),_:2},1024)))),128))]),(0,t.Lk)("div",P,[Q.value||$.value.length?((0,t.uX)(),(0,t.Wv)(M,{key:1,modelValue:x.value,"onUpdate:modelValue":a[3]||(a[3]=e=>x.value=e),"total-items":G.value,"items-per-page":R,"show-page-size":3,"force-ellipses":"",onChange:te},null,8,["modelValue","total-items"])):((0,t.uX)(),(0,t.Wv)(S,{key:0,description:"暂无报告"}))]),(0,t.bF)(n,{type:"info",block:"",onClick:se,class:"generate-btn",disabled:!A.value},{default:(0,t.k6)((()=>a[15]||(a[15]=[(0,t.eW)(" 生成PDF报告 ")]))),_:1},8,["disabled"])])])),_:1})])),_:1},8,["active"]),(0,t.Lk)("input",{type:"file",ref_key:"fileInput",ref:T,style:{display:"none"},onChange:B,accept:".pdf,.doc,.docx"},null,544),(0,t.bF)(oe,{show:X.value,"onUpdate:show":a[6]||(a[6]=e=>X.value=e),title:I.value?.fileName,class:"preview-dialog",closeable:"","close-icon":"close"},{default:(0,t.k6)((()=>[(0,t.Lk)("div",C,[(0,t.Lk)("div",{class:"resize-handle",onMousedown:Z},null,32),"application/pdf"===I.value?.fileType?((0,t.uX)(),(0,t.CE)("iframe",{key:0,src:I.value?.fileUrl,frameborder:"0",class:"pdf-preview"},null,8,_)):I.value?.fileType.startsWith("image/")?((0,t.uX)(),(0,t.CE)("img",{key:1,src:I.value?.fileUrl,class:"image-preview"},null,8,F)):((0,t.uX)(),(0,t.CE)("div",L,[(0,t.bF)(n,{type:"primary",onClick:a[5]||(a[5]=e=>O(I.value))},{default:(0,t.k6)((()=>a[16]||(a[16]=[(0,t.eW)("下载文件")]))),_:1}),a[17]||(a[17]=(0,t.Lk)("p",null,"该文件类型不支持在线预览",-1))]))])])),_:1},8,["show","title"]),(0,t.bF)(oe,{show:E.value,"onUpdate:show":a[7]||(a[7]=e=>E.value=e),title:"删除确认","show-cancel-button":"",onConfirm:ae},{default:(0,t.k6)((()=>a[18]||(a[18]=[(0,t.Lk)("div",{class:"delete-confirm-content"}," 确定要删除这份报告吗？此操作不可恢复。 ",-1)]))),_:1},8,["show"])])}}},U=l(1241);const W=(0,U.A)(K,[["__scopeId","data-v-0b6619bc"]]);var V=W}}]);
//# sourceMappingURL=973.fe0df548.js.map